<!-- for needs of LdapTestCase -->
<subsystem xmlns="urn:wildfly:elytron:1.0">

    <security-domains>
        <security-domain name="domain1" default-realm="LdapRealm" permission-mapper="constant-permissions">
            <realm name="LdapRealm"/>
        </security-domain>
    </security-domains>

    <dir-contexts>
        <dir-context name="DirContextInsecure" url="ldap://localhost:11391/" authentication-level="none"/>
        <dir-context name="DirContextSsl" url="ldaps://localhost:11391/" principal="uid=server,dc=elytron,dc=wildfly,dc=org" credential="serverPassword" ssl-context="LdapSslContext"/>
    </dir-contexts>

    <security-realms>
        <ldap-realm name="LdapRealm" direct-verification="false" dir-context="DirContextSsl">
            <identity-mapping rdn-identifier="uid" search-base-dn="dc=elytron,dc=wildfly,dc=org" use-recursive-search="true" iterator-filter="(uid=*)" new-identity-parent-dn="dc=elytron,dc=wildfly,dc=org">
                <attribute-mapping>
                    <attribute from="uid" to="userName"/>
                    <attribute from="cn" to="firstName"/>
                    <attribute from="sn" to="lastName"/>
                    <attribute from="telephoneNumber" to="phones"/>
                    <attribute filter-base-dn="ou=Finance,dc=elytron,dc=wildfly,dc=org" filter="(&amp;(objectClass=groupOfNames)(member={0}))" from="CN" as-rdn="OU"  to="businessArea"/>
                </attribute-mapping>
                <user-password-mapper from="userPassword" writable="true" verifiable="true"/>
                <otp-credential-mapper algorithm-from="otpAlgorithm" hash-from="otpHash" seed-from="otpSeed" sequence-from="otpSequence"/>
                <new-identity-attributes>
                    <attribute name="objectClass" value="top inetOrgPerson person organizationalPerson otpToken"/>
                    <attribute name="sn" value="BlankSurname"/>
                    <attribute name="cn" value="BlankCommonName"/>
                </new-identity-attributes>
            </identity-mapping>
        </ldap-realm>
    </security-realms>

    <credential-security-factories>
        <kerberos-security-factory name="KerberosFactory" principal="HTTP/localhost@EXAMPLE.COM" path="http.keytab" relative-to="jboss.server.config.dir" debug="true" mechanism-oids="1.2.840.113554.1.2.2 1.3.6.1.5.5.2"/>
    </credential-security-factories>

    <tls>
        <key-stores>
            <ldap-key-store name="LdapKeyStoreMinimal" dir-context="DirContextSsl" search-path="ou=keystore,dc=elytron,dc=wildfly,dc=org">
            </ldap-key-store>
            <ldap-key-store name="LdapKeyStoreMaximal" dir-context="DirContextSsl" search-path="dc=elytron,dc=wildfly,dc=org"
                            search-recursive="true" search-time-limit="1000" filter-alias="(&amp;(objectClass=inetOrgPerson)(sn={0}))"
                            filter-certificate="(&amp;(objectClass=inetOrgPerson)(usercertificate={0}))" filter-iterate="(sn=serenity*)">
                <new-item-template new-item-path="dc=elytron,dc=wildfly,dc=org" new-item-rdn="cn">
                    <attribute name="objectClass" value="top inetOrgPerson"/>
                    <attribute name="sn" value="NewKeyStoreItem"/>
                </new-item-template>
                <ldap-mapping alias-attribute="sn" certificate-attribute="usercertificate" certificate-type="X.509"
                              certificate-chain-attribute="userSMIMECertificate" certificate-chain-encoding="PKCS7" />
            </ldap-key-store>
            <key-store name="ElytronCaTruststore" type="JKS">
                <file path="ca.truststore" relative-to="jboss.server.config.dir" />
                <credential-reference clear-text="Elytron"/>
            </key-store>
        </key-stores>
        <trust-managers>
            <trust-manager name="ElytronTrustManager" algorithm="SunX509" key-store="ElytronCaTruststore"/>
        </trust-managers>
        <client-ssl-contexts>
            <client-ssl-context name="LdapSslContext" protocols="SSLv2 SSLv3 TLSv1 TLSv1_3 TLSv1_2 TLSv1_1" trust-managers="ElytronTrustManager" />
        </client-ssl-contexts>
    </tls>

    <mappers>
        <constant-permission-mapper name="constant-permissions">
            <permission class-name="org.wildfly.security.auth.permission.LoginPermission"/>
        </constant-permission-mapper>
    </mappers>

    <http>
        <http-authentication-factory name="SpnegoHttpAuthFactory" http-server-mechanism-factory="global" security-domain="domain1">
            <mechanism-configuration>
                <mechanism mechanism-name="SPNEGO" credential-security-factory="KerberosFactory">
                    <mechanism-realm realm-name="httpRealm1"/>
                </mechanism>
            </mechanism-configuration>
        </http-authentication-factory>
        <provider-http-server-mechanism-factory name="global"/>
    </http>

</subsystem>